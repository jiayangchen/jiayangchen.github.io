---
layout: post
title: "回顾《深入理解 Java 虚拟机》之类加载机制"
subtitle: "第三篇，虚拟机把描述类的数据从 Class 文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的 Java 类型，这就是虚拟机的类加载机制"
date: 2019-02-07
author: "ChenJY"
header-img: "img/java.jpg"
catalog: true
tags: 
    - JVM
---

虚拟机把描述类的数据从 `Class` 文件加载到内存，并对数据进行**校验、转换解析和初始化**，最终形成可以被虚拟机直接使用的 `Java` 类型，这就是虚拟机的**类加载机制**。

类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：**加载、验证、准备、解析、初始化、使用和卸载**七个阶段：

![](http://ww1.sinaimg.cn/large/c3beb895gy1fzy4dv64llj21090fgjt8.jpg)

除却解析之外，其他各个阶段都是严格按顺序执行的，解析则不一定，为了支持 `Java` 的运行时绑定特性，它有时在初始化之后才开始。下面分别叙述一下各个阶段做啥工作：

### 加载

加载时类加载过程的第一个阶段，在加载阶段，虚拟机需要完成以下三件事情：

1. 通过一个类的全限定名来获取其定义的二进制字节流。
2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。
3. 在Java堆中生成一个代表这个类的java.lang.Class对象，作为对方法区中这些数据的访问入口。

加载阶段完成后，虚拟机外部的二进制字节流就按照虚拟机所需的格式存储在方法区之中（具体存储格式由虚拟机自行实现），然后在内存中实例化一个 `java.lang.Class` 类的对象（并未明确规定必须在堆中，对 `HotSpot` 虚拟机而言，`Class` 对象较特殊，它虽然是对象但存在方法区中），这个对象将作为外部程序访问方法区中的这些类型数据的外部接口。

### 验证

验证的目的是为了确保 `Class` 文件中的字节流包含的信息符合当前虚拟机的要求，而且不会危害虚拟机自身的安全。不同的虚拟机对类验证的实现可能会有所不同，但大致都会完成以下四个阶段的验证：**文件格式的验证、元数据的验证、字节码验证和符号引用验证**。

### 准备

准备阶段是**正式为类变量分配内存并设置类变量初始值的阶段**，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：

1. 这时候进行内存分配的仅包括类变量`（static）`，而不包括实例变量，实例变量会在对象实例化时随着对象一块分配在 `Java` 堆中。
2. 这里所设置的初始值通常情况下是数据类型默认的零值（如 `0`、`0L`、`null`、`false` 等），而不是被在 `Java` 代码中被显式地赋予的值，之所以是通常情况，那是因为如果类字段的字段属性表中存在 `ConstantValue` 属性，那在准备阶段变量会被直接转换为 `ConstantValue` 属性所指定的值。

```java
	public static final int value = 123;
```

例如上述代码，编译时 `Javac` 将会为 `value` 生成 `ConstantValue` 属性，在准备阶段虚拟机就会根据 `ConstantValue` 的设置将 `value` 赋值为 `123`。

### 解析

解析阶段是虚拟机将常量池中的**符号引用**转化为**直接引用**的过程。那么符号引用和直接引用的区别与关联是什么呢？

1. **符号引用**：符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。符号引用与虚拟机实现的内存布局无关，引用的目标并不一定已经加载到了内存中。
2. **直接引用**：直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。直接引用是与虚拟机实现的内存布局相关的，同一个符号引用在不同虚拟机实例上翻译出来的直接引用一般不会相同。如果有了直接引用，那说明引用的目标必定已经存在于内存之中了。

### 初始化

初始化是类加载过程的最后一步，到了此阶段，才真正开始执行类中定义的 `Java` 程序代码。在准备阶段，类变量已经被赋过一次系统要求的初始值，而在初始化阶段，则是根据程序员通过程序指定的主观计划去初始化类变量和其他资源。

从另一个角度来说，初始化阶段是执行类构造器 `<cinit>()` 方法的过程：

![](http://ww1.sinaimg.cn/large/c3beb895gy1fzy5ffzulwj20xx0um0xz.jpg)

### 参考资料
-《深入理解Java虚拟机》 周志明著

### License
- 本文遵守创作共享 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><b>CC BY-NC-SA 3.0协议</b></a>